<html>
<head>
<title>ConsistentHashingSample.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ConsistentHashingSample.java</font>
</center></td></tr></table>
<pre><span class="s0">package </span><span class="s1">example</span><span class="s2">.</span><span class="s1">algorithms</span><span class="s2">;</span>

<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">HashSet</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">Map</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">Set</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">TreeMap</span><span class="s2">;</span>

<span class="s3">/**</span>
 <span class="s3">* Cloud/On-Premise 환경에서 요구되는 핵심 알고리즘 구현</span>
 <span class="s3">* </span>
 <span class="s3">* 분산 캐싱 알고리즘 (Consistent Hashing)</span>
 <span class="s3">* 해시 공간 (Hash Space)</span>
 <span class="s3">*   일반적으로 0 ~ 2³²-1의 정수 범위를 사용하는 원형 공간.</span>
 <span class="s3">* 해시 링 (Hash Ring)</span>
 <span class="s3">*   해시 공간을 원형 구조로 연결한 것. 맨 끝과 처음이 연결되어 순환 구조를 이룸.</span>
 <span class="s3">* 키-서버 매핑</span>
 <span class="s3">*   키와 서버 모두 해시 함수를 통해 링에 위치시킨다.</span>
 <span class="s3">*   키는 자신보다 해시값이 큰 첫 번째 서버에 매핑된다 (시계 방향 탐색).</span>
 <span class="s3">* </span>
 <span class="s3">*/</span>
<span class="s0">public class </span><span class="s1">ConsistentHashingSample </span><span class="s2">{</span>

	<span class="s4">// ===== 분산 캐싱 알고리즘 (Consistent Hashing) =====</span>

	<span class="s3">/**</span>
	 <span class="s3">* 일관된 해싱을 구현하는 클래스</span>
	 <span class="s3">*/</span>
	<span class="s0">static class </span><span class="s1">ConsistentHashRing </span><span class="s2">{</span>
		<span class="s0">private </span><span class="s1">TreeMap</span><span class="s2">&lt;</span><span class="s1">Integer</span><span class="s2">, </span><span class="s1">String</span><span class="s2">&gt; </span><span class="s1">ring</span><span class="s2">;</span>
		<span class="s0">private </span><span class="s1">Set</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt; </span><span class="s1">nodes</span><span class="s2">;</span>
		<span class="s0">private int </span><span class="s1">virtualNodeCount</span><span class="s2">;</span>

		<span class="s0">public </span><span class="s1">ConsistentHashRing</span><span class="s2">(</span><span class="s0">int </span><span class="s1">virtualNodeCount</span><span class="s2">) {</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">ring </span><span class="s2">= </span><span class="s0">new </span><span class="s1">TreeMap</span><span class="s2">&lt;&gt;();</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">nodes </span><span class="s2">= </span><span class="s0">new </span><span class="s1">HashSet</span><span class="s2">&lt;&gt;();</span>
			<span class="s0">this</span><span class="s2">.</span><span class="s1">virtualNodeCount </span><span class="s2">= </span><span class="s1">virtualNodeCount</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s3">/**</span>
		 <span class="s3">* 노드를 링에 추가하는 메소드</span>
		 <span class="s3">*/</span>
		<span class="s0">public void </span><span class="s1">addNode</span><span class="s2">(</span><span class="s1">String node</span><span class="s2">) {</span>
			<span class="s1">nodes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">node</span><span class="s2">);</span>
			<span class="s0">int </span><span class="s1">hash </span><span class="s2">= </span><span class="s1">calculateHash</span><span class="s2">(</span><span class="s1">node</span><span class="s2">);</span>
			<span class="s1">ring</span><span class="s2">.</span><span class="s1">put</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">, </span><span class="s1">node</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s3">/**</span>
		 <span class="s3">* 노드를 링에서 제거하는 메소드</span>
		 <span class="s3">*/</span>
		<span class="s0">public void </span><span class="s1">removeNode</span><span class="s2">(</span><span class="s1">String node</span><span class="s2">) {</span>
			<span class="s1">nodes</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">node</span><span class="s2">);</span>
			<span class="s0">int </span><span class="s1">hash </span><span class="s2">= </span><span class="s1">calculateHash</span><span class="s2">(</span><span class="s1">node</span><span class="s2">);</span>
			<span class="s1">ring</span><span class="s2">.</span><span class="s1">put</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">, </span><span class="s1">node</span><span class="s2">);</span>
			<span class="s1">ring</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s3">/**</span>
		 <span class="s3">* 키에 대한 노드를 찾는 메소드</span>
		 <span class="s3">*/</span>
		<span class="s0">public </span><span class="s1">String getNode</span><span class="s2">(</span><span class="s1">String key</span><span class="s2">) {</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">ring</span><span class="s2">.</span><span class="s1">isEmpty</span><span class="s2">())</span>
				<span class="s0">return null</span><span class="s2">;</span>

			<span class="s0">int </span><span class="s1">hash </span><span class="s2">= </span><span class="s1">calculateHash</span><span class="s2">(</span><span class="s1">key</span><span class="s2">);</span>

			<span class="s4">// 해시보다 큰 첫 번째 노드를 찾음</span>
			<span class="s1">Map</span><span class="s2">.</span><span class="s1">Entry</span><span class="s2">&lt;</span><span class="s1">Integer</span><span class="s2">, </span><span class="s1">String</span><span class="s2">&gt; </span><span class="s1">entry </span><span class="s2">= </span><span class="s1">ring</span><span class="s2">.</span><span class="s1">ceilingEntry</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">);</span>

			<span class="s4">// 찾지 못하면 링의 첫 번째 노드를 반환 (순환 구조)</span>
			<span class="s0">if </span><span class="s2">(</span><span class="s1">entry </span><span class="s2">== </span><span class="s0">null</span><span class="s2">) {</span>
				<span class="s1">entry </span><span class="s2">= </span><span class="s1">ring</span><span class="s2">.</span><span class="s1">firstEntry</span><span class="s2">();</span>
			<span class="s2">}</span>

			<span class="s0">return </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">getValue</span><span class="s2">();</span>
		<span class="s2">}</span>

		<span class="s3">/**</span>
		 <span class="s3">* 해시 함수 (간단한 해시 구현)</span>
		 <span class="s3">*/</span>
		<span class="s0">private int </span><span class="s1">calculateHash</span><span class="s2">(</span><span class="s1">String input</span><span class="s2">) {</span>
			<span class="s0">return </span><span class="s1">input</span><span class="s2">.</span><span class="s1">hashCode</span><span class="s2">() % </span><span class="s1">virtualNodeCount</span><span class="s2">;</span>
		<span class="s2">}</span>

		<span class="s3">/**</span>
		 <span class="s3">* 현재 링 상태를 출력하는 메소드</span>
		 <span class="s3">*/</span>
		<span class="s0">public void </span><span class="s1">printRing</span><span class="s2">() {</span>
			<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;=== Consistent Hash Ring ===&quot;</span><span class="s2">);</span>
			<span class="s0">for </span><span class="s2">(</span><span class="s1">Map</span><span class="s2">.</span><span class="s1">Entry</span><span class="s2">&lt;</span><span class="s1">Integer</span><span class="s2">, </span><span class="s1">String</span><span class="s2">&gt; </span><span class="s1">entry </span><span class="s2">: </span><span class="s1">ring</span><span class="s2">.</span><span class="s1">entrySet</span><span class="s2">()) {</span>
				<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;Hash: &quot; </span><span class="s2">+ </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">getKey</span><span class="s2">() + </span><span class="s5">&quot; -&gt; Node: &quot; </span><span class="s2">+ </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">getValue</span><span class="s2">());</span>
			<span class="s2">}</span>
		<span class="s2">}</span>
	<span class="s2">}</span>

	<span class="s3">/**</span>
	 <span class="s3">* 일관된 해싱 테스트</span>
	 <span class="s3">*/</span>
	<span class="s0">public static void </span><span class="s1">testConsistentHashing</span><span class="s2">() {</span>
		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;========== Consistent Hashing Test ==========&quot;</span><span class="s2">);</span>

		<span class="s1">ConsistentHashRing ring </span><span class="s2">= </span><span class="s0">new </span><span class="s1">ConsistentHashRing</span><span class="s2">(</span><span class="s6">3</span><span class="s2">);</span>

		<span class="s4">// 노드 추가</span>
		<span class="s1">ring</span><span class="s2">.</span><span class="s1">addNode</span><span class="s2">(</span><span class="s5">&quot;node1&quot;</span><span class="s2">);</span>
		<span class="s1">ring</span><span class="s2">.</span><span class="s1">addNode</span><span class="s2">(</span><span class="s5">&quot;node2&quot;</span><span class="s2">);</span>
		<span class="s1">ring</span><span class="s2">.</span><span class="s1">addNode</span><span class="s2">(</span><span class="s5">&quot;node3&quot;</span><span class="s2">);</span>

		<span class="s4">// 키 분배 테스트</span>
		<span class="s1">String</span><span class="s2">[] </span><span class="s1">keys </span><span class="s2">= { </span><span class="s5">&quot;user1&quot;</span><span class="s2">, </span><span class="s5">&quot;user2&quot;</span><span class="s2">, </span><span class="s5">&quot;user3&quot;</span><span class="s2">, </span><span class="s5">&quot;user4&quot;</span><span class="s2">, </span><span class="s5">&quot;user5&quot;</span><span class="s2">, </span><span class="s5">&quot;data1&quot;</span><span class="s2">, </span><span class="s5">&quot;data2&quot;</span><span class="s2">, </span><span class="s5">&quot;data3&quot; </span><span class="s2">};</span>

		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;--- Key Distribution ---&quot;</span><span class="s2">);</span>
		<span class="s0">for </span><span class="s2">(</span><span class="s1">String key </span><span class="s2">: </span><span class="s1">keys</span><span class="s2">) {</span>
			<span class="s1">String node </span><span class="s2">= </span><span class="s1">ring</span><span class="s2">.</span><span class="s1">getNode</span><span class="s2">(</span><span class="s1">key</span><span class="s2">);</span>
			<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;Key: &quot; </span><span class="s2">+ </span><span class="s1">key </span><span class="s2">+ </span><span class="s5">&quot; -&gt; Node: &quot; </span><span class="s2">+ </span><span class="s1">node</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s4">// 노드 제거 후 테스트</span>
		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;--- After removing node2 ---&quot;</span><span class="s2">);</span>
		<span class="s1">ring</span><span class="s2">.</span><span class="s1">removeNode</span><span class="s2">(</span><span class="s5">&quot;node2&quot;</span><span class="s2">);</span>
		<span class="s0">for </span><span class="s2">(</span><span class="s1">String key </span><span class="s2">: </span><span class="s1">keys</span><span class="s2">) {</span>
			<span class="s1">String node </span><span class="s2">= </span><span class="s1">ring</span><span class="s2">.</span><span class="s1">getNode</span><span class="s2">(</span><span class="s1">key</span><span class="s2">);</span>
			<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;Key: &quot; </span><span class="s2">+ </span><span class="s1">key </span><span class="s2">+ </span><span class="s5">&quot; -&gt; Node: &quot; </span><span class="s2">+ </span><span class="s1">node</span><span class="s2">);</span>
		<span class="s2">}</span>

		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">();</span>
	<span class="s2">}</span>

	<span class="s3">/**</span>
	 <span class="s3">* 메인 메소드 - 테스트 실행</span>
	 <span class="s3">*/</span>
	<span class="s0">public static void </span><span class="s1">main</span><span class="s2">(</span><span class="s1">String</span><span class="s2">[] </span><span class="s1">args</span><span class="s2">) {</span>
		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;일관된 해싱 테스트 테스트 시작&quot;</span><span class="s2">);</span>
		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;=&quot;</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s6">40</span><span class="s2">));</span>

		<span class="s0">try </span><span class="s2">{</span>
			<span class="s4">// 일관된 해싱 테스트</span>
			<span class="s1">testConsistentHashing</span><span class="s2">();</span>

		<span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">Exception e</span><span class="s2">) {</span>
			<span class="s1">System</span><span class="s2">.</span><span class="s1">err</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;테스트 중 오류 발생: &quot; </span><span class="s2">+ </span><span class="s1">e</span><span class="s2">.</span><span class="s1">getMessage</span><span class="s2">());</span>
			<span class="s1">e</span><span class="s2">.</span><span class="s1">printStackTrace</span><span class="s2">();</span>
		<span class="s2">}</span>

		<span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s5">&quot;일관된 해싱 테스트 테스트 완료&quot;</span><span class="s2">);</span>
	<span class="s2">}</span>

<span class="s2">}</span>
</pre>
</body>
</html>